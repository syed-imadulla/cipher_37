<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sell Product - Profitify</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #8B5FBF;
            --secondary: #4ECDC4;
            --text: #4A5568;
            --card-bg: rgba(255, 255, 255, 0.92);
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            --pastel-purple: #D6BCFA;
            --pastel-blue: #A8D8EA;
            --sky-blue: #87CEEB;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--text);
            min-height: 100vh
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px
        }

        /* Header */
        header {
            background: var(--glass);
            backdrop-filter: blur(15px);
            position: fixed;
            width: 100%;
            top: 15px;
            z-index: 1000;
            box-shadow: var(--shadow);
            border-radius: 20px;
            margin: 0 20px;
            width: calc(100% - 40px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .logo i {
            margin-right: 10px;
            font-size: 1.8rem;
        }

        .logo a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            list-style: none;
        }

        .nav-links li {
            margin-left: 30px;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            transition: color 0.3s;
            position: relative;
        }

        .nav-links a:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 0;
            background-color: var(--primary);
            transition: width 0.3s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .nav-links a:hover:after {
            width: 100%;
        }

        .auth-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #7a4ba8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 95, 191, 0.3);
        }
        /* Layout */
        .sell-product {
            padding: 110px 0 60px
        }

        .sell-product-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px
        }

        .back-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, .5);
            color: var(--text)
        }

        .sell-product-header h1 {
            font-size: 2.2rem;
            color: #2d3748;
            flex: 1;
            text-align: center
        }

        /* Mode cards */
        .mode-selection {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 24px
        }

        .mode-card {
            background: var(--card-bg);
            padding: 22px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            cursor: pointer;
            flex: 1;
            max-width: 320px;
            border: 1px solid rgba(255, 255, 255, .45);
            text-align: center
        }

        .mode-card.active {
            border-color: var(--primary);
            box-shadow: 0 12px 30px rgba(139, 95, 191, 0.18)
        }

        .mode-icon {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 22px
        }

        .scan-icon {
            background: var(--pastel-purple);
            color: var(--primary)
        }

        .manual-icon {
            background: var(--pastel-blue);
            color: #2a7a9c
        }

        /* Status */
        .status-message {
            padding: 12px 16px;
            border-radius: 10px;
            margin: 0 auto 20px;
            max-width: 1100px;
            display: flex;
            align-items: center;
            gap: 12px
        }

        .status-message.info {
            background: #d7eefb;
            border: 1px solid #97d0f8;
            color: #0d4d7a
        }

        .status-message.success {
            background: #dff7ee;
            border: 1px solid #2a9d8f;
            color: #0f594d
        }

        .status-message.error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828
        }

        /* Scanner section - improved */
        .scanner-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.45);
            box-shadow: var(--shadow);
            margin-bottom: 28px;
            display: none
        }

        .scanner-section.active {
            display: block
        }

        .scanner-inner {
            display: flex;
            gap: 18px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center
        }

        #scannerPreview {
            width: 460px;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            background: #0b0b0b;
            color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .12);
            border: 1px solid rgba(255, 255, 255, .03)
        }

        .scanner-controls {
            min-width: 220px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start
        }

        .scanner-btn {
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.06);
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.06)
        }

        .scanner-btn:active {
            transform: translateY(1px)
        }

        .scanner-status {
            font-size: 0.95rem;
            color: var(--text);
            opacity: .9
        }

        /* Manual form */
        .manual-form-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.45);
            box-shadow: var(--shadow);
            margin-bottom: 28px;
            display: none
        }

        .manual-form-section.active {
            display: block
        }

        .form-section {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06)
        }

        .section-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d3748
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-bottom: 12px
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #E5E7EB;
            background: #fff
        }

        /* Product card & cart */
        .product-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
            border: 1px solid rgba(255, 255, 255, .45)
        }

        .product-image {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--pastel-purple), var(--sky-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.2rem
        }

        .product-details h3 {
            margin: 0 0 4px;
            font-size: 1rem
        }

        .product-price {
            color: var(--primary);
            font-weight: 700
        }

        .cart-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.45);
            box-shadow: var(--shadow);
            margin-bottom: 28px;
            display: none
        }

        .cart-section.active {
            display: block
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06)
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 18px
        }

        footer {
            background: #2d3748;
            color: white;
            padding: 48px 0 30px;
            border-radius: 24px 24px 0 0;
            margin-top: 32px
        }

        @media (max-width:820px) {
            #scannerPreview {
                width: 100%;
                height: 220px
            }

            .scanner-controls {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center
            }

            .scanner-btn {
                flex: 1 1 calc(50% - 8px);
                text-align: center
            }

            .mode-selection {
                flex-direction: column
            }

            .sell-product {
                padding-top: 140px
            }
        }
    </style>

    <!-- Quagga -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <a href="/">
                        <i class="fas fa-chart-line"></i>
                        <span>Profitify</span>
                    </a>
                </div>
                <div class="auth-buttons">
                    <a href="/dashboard/" class="btn btn-outline">Dashboard</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="sell-product">
        <div class="container">
            <div class="sell-product-header">
                <a class="back-btn" href="/dashboard/"><i class="fas fa-arrow-left"></i></a>
                <h1>Sell Products</h1>
                <div style="width:50px"></div>
            </div>

            <div class="mode-selection">
                <div class="mode-card active" data-mode="scan">
                    <div class="mode-icon scan-icon"><i class="fas fa-barcode"></i></div>
                    <h3>Scan Barcode</h3>
                    <p>Quickly add products to cart by scanning barcodes</p>
                </div>
                <div class="mode-card" data-mode="manual">
                    <div class="mode-icon manual-icon"><i class="fas fa-search"></i></div>
                    <h3>Search Products</h3>
                    <p>Find and add products manually from your inventory</p>
                </div>
            </div>

            <div id="scanStatus" class="status-message info" role="status">
                <i class="fas fa-info-circle"></i><span>Select a method above to sell products</span>
            </div>

            <!-- Scanner Section -->
            <div id="scannerSection" class="scanner-section active" aria-hidden="false">
                <div class="scanner-inner">
                    <div id="scannerPreview" aria-live="polite" role="region" title="Barcode camera preview">
                        <div style="text-align:center;opacity:.8">
                            <i class="fas fa-camera" style="font-size:28px;margin-bottom:8px"></i>
                            <div>Camera preview will appear here</div>
                        </div>
                    </div>

                    <div class="scanner-controls" aria-controls="scannerPreview">
                        <button id="startScanner" class="scanner-btn"><i class="fas fa-play"></i> Start Scanner</button>
                        <button id="stopScanner" class="scanner-btn" style="display:none"><i class="fas fa-stop"></i>
                            Stop Scanner</button>
                        <button id="useManual" class="scanner-btn"><i class="fas fa-search"></i> Use Manual
                            Entry</button>
                        <div id="scannerSmallStatus" class="scanner-status">Scanner stopped</div>
                    </div>
                </div>
            </div>

            <!-- Manual Form / Search -->
            <div id="manualFormSection" class="manual-form-section">
                <div class="form-section">
                    <h2 class="section-title"><i class="fas fa-search"></i> Search Products</h2>
                    <div class="form-group">
                        <input type="text" id="productSearch" class="form-control"
                            placeholder="Search by product name, brand, or category">
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="section-title"><i class="fas fa-boxes"></i> Available Products</h2>
                    <div id="productList"></div>
                </div>
            </div>

            <!-- Cart -->
            <div id="cartSection" class="cart-section">
                <div class="cart-header"
                    style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h2>Shopping Cart</h2>
                    <div>
                        <button class="scanner-btn" id="clearCartBtn"><i class="fas fa-trash"></i> Clear Cart</button>
                    </div>
                </div>

                <div id="cartItems" class="cart-items"></div>

                <div class="cart-summary" style="margin-top:14px">
                    <div class="summary-row" style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>Subtotal:</span><span id="subtotal">₹0.00</span>
                    </div>
                    <div class="summary-row" style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>Tax (10%):</span><span id="tax">₹0.00</span>
                    </div>
                    <div class="summary-row summary-total"
                        style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px solid rgba(0,0,0,0.06)">
                        <span>Total:</span><span id="total">₹0.00</span>
                    </div>
                </div>

                <div class="form-actions" style="margin-top:18px">
                    <button class="scanner-btn" id="continueShoppingBtn"><i class="fas fa-shopping-cart"></i> Continue
                        Shopping</button>
                    <button class="scanner-btn" id="completeSaleBtn" style="background:var(--secondary);color:#fff"><i
                            class="fas fa-cash-register"></i> Complete Sale</button>
                </div>
            </div>

        </div>
    </main>

    <footer>
        <div class="container">
            <div
                style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:20px">
                <div>
                    <h3 style="color:white">Profitify</h3>
                    <p style="color:#CBD5E0">Making inventory management simple and profitable through AI and smart
                        analytics.</p>
                </div>
                <div>
                    <h3 style="color:white">Product</h3>
                    <ul style="list-style:none;padding:0;color:#CBD5E0">
                        <li><a style="color:#CBD5E0" href="#">Features</a></li>
                    </ul>
                </div>
                <div>
                    <h3 style="color:white">Support</h3>
                    <ul style="list-style:none;padding:0;color:#CBD5E0">
                        <li><a style="color:#CBD5E0" href="#">Help Center</a></li>
                    </ul>
                </div>
                <div>
                    <h3 style="color:white">Legal</h3>
                    <ul style="list-style:none;padding:0;color:#CBD5E0">
                        <li><a style="color:#CBD5E0" href="#">Privacy</a></li>
                    </ul>
                </div>
            </div>
            <div style="text-align:center;color:#CBD5E0;padding-top:12px">&copy; 2025 Profitify. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // Full page JS: scanner + product list + cart
        document.addEventListener('DOMContentLoaded', function () {
            // Elements
            const modeCards = document.querySelectorAll('.mode-card');
            const scannerSection = document.getElementById('scannerSection');
            const manualFormSection = document.getElementById('manualFormSection');
            const cartSection = document.getElementById('cartSection');
            const scanStatus = document.getElementById('scanStatus');
            const startScannerBtn = document.getElementById('startScanner');
            const stopScannerBtn = document.getElementById('stopScanner');
            const useManualBtn = document.getElementById('useManual');
            const scannerSmallStatus = document.getElementById('scannerSmallStatus');
            const previewTarget = document.getElementById('scannerPreview');

            const productSearch = document.getElementById('productSearch');
            const productList = document.getElementById('productList');

            const cartItems = document.getElementById('cartItems');
            const clearCartBtn = document.getElementById('clearCartBtn');
            const continueShoppingBtn = document.getElementById('continueShoppingBtn');
            const completeSaleBtn = document.getElementById('completeSaleBtn');
            const subtotalEl = document.getElementById('subtotal');
            const taxEl = document.getElementById('tax');
            const totalEl = document.getElementById('total');

            // Mock product DB (barcode => product)
            const productDatabase = {
                '123456789012': { id: 'p001', name: 'Premium Wireless Headphones', brand: 'AudioTech', category: 'electronics', description: 'Noise cancelling headphones', costPrice: 45.00, sellingPrice: 89.99, stock: 25 },
                '234567890123': { id: 'p002', name: 'Organic Green Tea', brand: 'NatureLeaf', category: 'food', description: 'Premium green tea', costPrice: 8.50, sellingPrice: 15.99, stock: 50 },
                '345678901234': { id: 'p003', name: 'Yoga Mat Premium', brand: 'FlexFit', category: 'sports', description: 'Non-slip yoga mat', costPrice: 22.00, sellingPrice: 39.99, stock: 15 },
                '456789012345': { id: 'p004', name: 'Smart Fitness Tracker', brand: 'FitTech', category: 'electronics', description: 'Fitness tracker with HR', costPrice: 35.00, sellingPrice: 69.99, stock: 30 },
                '567890123456': { id: 'p005', name: 'Natural Body Lotion', brand: 'PureSkin', category: 'beauty', description: 'Moisturizing lotion', costPrice: 6.50, sellingPrice: 12.99, stock: 40 }
            };

            // Cart
            let cart = [];

            // UI helpers
            function setStatus(type, html) {
                if (!scanStatus) return;
                scanStatus.className = 'status-message ' + (type || 'info');
                scanStatus.innerHTML = html || '';
            }
            function setSmallStatus(txt) { if (scannerSmallStatus) scannerSmallStatus.textContent = txt; }

            function showScanner(show) { if (!scannerSection) return; scannerSection.classList.toggle('active', !!show); if (manualFormSection) manualFormSection.classList.toggle('active', !!(!show)); }
            function showManual(show) { if (!manualFormSection) return; manualFormSection.classList.toggle('active', !!show); if (scannerSection) scannerSection.classList.toggle('active', !!(!show)); }

            // Mode toggles
            modeCards.forEach(card => {
                card.addEventListener('click', function () {
                    const mode = this.getAttribute('data-mode');
                    modeCards.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');

                    if (mode === 'scan') {
                        showScanner(true);
                        setStatus('info', '<i class="fas fa-info-circle"></i><span>Ready to scan. Click Start Scanner to begin.</span>');
                    } else {
                        showManual(true);
                        setStatus('info', '<i class="fas fa-search"></i><span>Search for products to add to your cart.</span>');
                        loadProductList();
                    }
                });
            });

            // Product list rendering + search
            function loadProductList(searchTerm = '') {
                productList.innerHTML = '';
                Object.values(productDatabase).forEach(prod => {
                    if (searchTerm && !(
                        prod.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        prod.brand.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        prod.category.toLowerCase().includes(searchTerm.toLowerCase())
                    )) return;

                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
            <div class="product-image"><i class="fas fa-box"></i></div>
            <div class="product-details" style="flex:1">
              <h3>${prod.name}</h3>
              <p style="margin:2px 0;color:var(--text)">${prod.brand} • ${prod.category}</p>
              <div style="display:flex;gap:12px;align-items:center">
                <div class="product-price">₹${prod.sellingPrice.toFixed(2)}</div>
                <div class="product-stock" style="font-size:0.9rem;color:var(--text)">In stock: ${prod.stock}</div>
              </div>
            </div>
            <button class="scanner-btn add-to-cart" data-id="${prod.id}"><i class="fas fa-cart-plus"></i> Add</button>
          `;
                    productList.appendChild(card);
                });

                // hook add buttons
                document.querySelectorAll('.add-to-cart').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        const product = Object.values(productDatabase).find(p => p.id === id);
                        if (product) {
                            addToCart(product);
                            setStatus('success', `<i class="fas fa-check-circle"></i><span>Product "${product.name}" added to cart!</span>`);
                            showCart();
                        }
                    });
                });
            }

            productSearch.addEventListener('input', function () { loadProductList(this.value); });

            // Cart operations
            function addToCart(product) {
                const existing = cart.find(i => i.id === product.id);
                if (existing) existing.quantity++;
                else cart.push({ id: product.id, name: product.name, brand: product.brand, price: product.sellingPrice, quantity: 1 });
                updateCartDisplay();
            }

            function updateCartDisplay() {
                cartItems.innerHTML = '';
                if (cart.length === 0) {
                    cartItems.innerHTML = '<p>Your cart is empty</p>';
                    subtotalEl.textContent = '₹0.00'; taxEl.textContent = '₹0.00'; totalEl.textContent = '₹0.00';
                    return;
                }
                let subtotal = 0;
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity; subtotal += itemTotal;
                    const div = document.createElement('div'); div.className = 'cart-item';
                    div.innerHTML = `
            <div style="display:flex;gap:12px;align-items:center">
              <div class="item-image"><i class="fas fa-box"></i></div>
              <div class="item-info"><h4 style="margin:0">${item.name}</h4><div style="font-size:0.9rem;color:var(--text)">${item.brand}</div><div style="color:var(--text);font-size:0.9rem">₹${item.price.toFixed(2)} each</div></div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="display:flex;align-items:center;gap:8px">
                <button class="quantity-btn decrease" data-id="${item.id}"><i class="fas fa-minus"></i></button>
                <div>${item.quantity}</div>
                <button class="quantity-btn increase" data-id="${item.id}"><i class="fas fa-plus"></i></button>
              </div>
              <div style="font-weight:700">₹${itemTotal.toFixed(2)}</div>
            </div>
          `;
                    cartItems.appendChild(div);
                });

                // bind quantity buttons
                document.querySelectorAll('.decrease').forEach(b => b.addEventListener('click', () => updateQuantity(b.getAttribute('data-id'), -1)));
                document.querySelectorAll('.increase').forEach(b => b.addEventListener('click', () => updateQuantity(b.getAttribute('data-id'), 1)));

                const tax = subtotal * 0.1; const total = subtotal + tax;
                subtotalEl.textContent = `₹${subtotal.toFixed(2)}`; taxEl.textContent = `₹${tax.toFixed(2)}`; totalEl.textContent = `₹${total.toFixed(2)}`;
            }

            function updateQuantity(id, delta) {
                const item = cart.find(i => i.id === id);
                if (!item) return;
                item.quantity += delta;
                if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
                updateCartDisplay();
            }

            clearCartBtn.addEventListener('click', () => { cart = []; updateCartDisplay(); setStatus('info', '<i class="fas fa-info-circle"></i><span>Cart cleared. Continue adding products.</span>'); });

            continueShoppingBtn.addEventListener('click', () => { document.querySelector('.mode-card[data-mode="scan"]').click(); });

            completeSaleBtn.addEventListener('click', () => {
                if (cart.length === 0) { setStatus('error', '<i class="fas fa-exclamation-triangle"></i><span>Your cart is empty. Add products before completing sale.</span>'); return; }
                setStatus('info', '<i class="fas fa-spinner fa-spin"></i><span>Processing sale...</span>');
                setTimeout(() => {
                    setStatus('success', '<i class="fas fa-check-circle"></i><span>Sale completed successfully!</span>');
                    cart = []; updateCartDisplay();
                    setTimeout(() => document.querySelector('.mode-card[data-mode="scan"]').click(), 1500);
                }, 1200);
            });

            function showCart() { cartSection.classList.add('active'); }

            // Barcode scanning integration (Quagga)
            let scannerRunning = false;
            function quaggaSupported() { return !!window.Quagga; }

            function onDetected(result) {
                if (!result || !result.codeResult || !result.codeResult.code) return;
                const code = result.codeResult.code;
                // Dispatch event for page to handle (unified)
                window.dispatchEvent(new CustomEvent('barcodeScanned', { detail: { code } }));
                stopQuagga();
            }

            function startQuagga() {
                if (scannerRunning) return;
                if (!quaggaSupported()) {
                    // fallback simulate quick scan
                    setSmallStatus('Camera unavailable — simulating scan');
                    setTimeout(() => {
                        const keys = Object.keys(productDatabase);
                        const rand = keys[Math.floor(Math.random() * keys.length)];
                        window.dispatchEvent(new CustomEvent('barcodeScanned', { detail: { code: rand } }));
                    }, 900);
                    return;
                }

                try {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: previewTarget,
                            constraints: { width: 640, height: 480, facingMode: "environment" }
                        },
                        decoder: { readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader", "upc_e_reader"], multiple: false },
                        locate: true
                    }, function (err) {
                        if (err) {
                            console.error("Quagga init error:", err);
                            setStatus('error', '<i class="fas fa-exclamation-triangle"></i><span>Unable to access camera. Use manual search.</span>');
                            setSmallStatus('Scanner unavailable');
                            return;
                        }
                        Quagga.start();
                        Quagga.onDetected(onDetected);
                        scannerRunning = true;
                        startScannerBtn.style.display = 'none';
                        stopScannerBtn.style.display = 'inline-block';
                        setSmallStatus('Scanning... point camera at barcode');
                        setStatus('info', '<i class="fas fa-camera"></i><span>Scanning... point camera at barcode</span>');
                    });
                } catch (ex) {
                    console.error('Quagga start exception', ex);
                    setStatus('error', '<i class="fas fa-exclamation-triangle"></i><span>Unable to start camera. Use manual search.</span>');
                }
            }

            function stopQuagga() {
                if (!scannerRunning) {
                    startScannerBtn.style.display = 'inline-block';
                    stopScannerBtn.style.display = 'none';
                    setSmallStatus('Scanner stopped');
                    return;
                }
                try { Quagga.offDetected(onDetected); Quagga.stop(); } catch (e) { }
                scannerRunning = false;
                startScannerBtn.style.display = 'inline-block';
                stopScannerBtn.style.display = 'none';
                setSmallStatus('Scanner stopped');
                setStatus('info', '<i class="fas fa-info-circle"></i><span>Scanner stopped</span>');
                // remove injected preview nodes if present
                const injected = previewTarget.querySelector('video, canvas');
                if (injected) injected.remove();
            }

            // Buttons
            startScannerBtn.addEventListener('click', () => { document.querySelector('.mode-card[data-mode="scan"]').click(); startQuagga(); });
            stopScannerBtn.addEventListener('click', stopQuagga);
            useManualBtn.addEventListener('click', () => { stopQuagga(); document.querySelector('.mode-card[data-mode="manual"]').click(); });

            // Handle scanned barcode event
            window.addEventListener('barcodeScanned', function (e) {
                const code = (e && e.detail && (e.detail.code || e.detail)) || '';
                if (!code) return;
                const product = productDatabase[code];
                if (product) {
                    addToCart(product);
                    setStatus('success', `<i class="fas fa-check-circle"></i><span>Product "${product.name}" added to cart!</span>`);
                    showCart();
                } else {
                    // If barcode not found, switch to manual search and inject code into search input
                    productSearch.value = code;
                    loadProductList(code);
                    document.querySelector('.mode-card[data-mode="manual"]').click();
                    setStatus('error', `<i class="fas fa-exclamation-triangle"></i><span>Barcode ${code} not found. Search results shown for manual add.</span>`);
                }
            });

            // initialize UI
            loadProductList();
            // default: show scanner mode active
            document.querySelector('.mode-card[data-mode="scan"]').click();

            // cleanup on unload
            window.addEventListener('beforeunload', () => { if (scannerRunning) stopQuagga(); });
        });
    </script>
</body>

</html>