<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Advisor - Profitify</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #8B5FBF;
            --secondary: #4ECDC4;
            --accent: #FF9E64;
            --light: #F7F9FC;
            --dark: #2D3748;
            --pastel-blue: #A8D8EA;
            --pastel-green: #C7F0DB;
            --pastel-yellow: #FFEAA7;
            --pastel-purple: #D6BCFA;
            --sky-blue: #87CEEB;
            --vibrant-yellow: #FFD166;
            --soft-purple: #C8B6FF;
            --text: #4A5568;
            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            --glass: rgba(255, 255, 255, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--text);
            line-height: 1.6;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            padding-top: 100px;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header & Navigation */

        header {
            background: var(--glass);
            backdrop-filter: blur(15px);
            position: fixed;
            width: 100%;
            top: 15px;
            z-index: 1000;
            box-shadow: var(--shadow);
            border-radius: 20px;
            margin: 0 20px;
            width: calc(100% - 40px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .logo i {
            margin-right: 10px;
            font-size: 1.8rem;
        }

        .logo a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            list-style: none;
        }

        .nav-links li {
            margin-left: 30px;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            transition: color 0.3s;
            position: relative;
        }

        .nav-links a:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 0;
            background-color: var(--primary);
            transition: width 0.3s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .nav-links a:hover:after {
            width: 100%;
        }

        .auth-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #7a4ba8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 95, 191, 0.3);
        }

        .btn-secondary {
            background: var(--vibrant-yellow);
            color: #5a4a00;
        }

        .btn-secondary:hover {
            background: #ffc94d;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 209, 102, 0.3);
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover {
            background: #ff8c42;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 158, 100, 0.3);
        }

        /* AI Advisor Header */

        .advisor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .back-btn {
            background: var(--card-bg);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--text);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            background: var(--primary);
            color: white;
        }

        .advisor-header h1 {
            font-size: 2rem;
            color: var(--dark);
            flex: 1;
            text-align: center;
        }

        .settings-btn {
            background: var(--card-bg);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--text);
        }

        .settings-btn:hover {
            transform: translateY(-2px);
            background: var(--primary);
            color: white;
        }

        /* Alert Cards Section */

        .alerts-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .alert-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .alert-card:hover {
            transform: translateY(-5px);
        }

        .alert-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
        }

        .trend-alert:before {
            background: var(--pastel-purple);
        }

        .waste-alert:before {
            background: var(--accent);
        }

        .recoder-alert:before {
            background: var(--pastel-blue);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .alert-title {
            font-size: 1.3rem;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .alert-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-left: 15px;
        }

        .trend-icon {
            background: var(--pastel-purple);
            color: var(--primary);
        }

        .waste-icon {
            background: rgba(255, 158, 100, 0.2);
            color: var(--accent);
        }

        .recoder-icon {
            background: var(--pastel-blue);
            color: #2a7a9c;
        }

        .alert-content {
            margin-bottom: 20px;
        }

        .alert-description {
            color: var(--text);
            margin-bottom: 15px;
        }

        .alert-products {
            list-style: none;
            margin-top: 10px;
        }

        .alert-product {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .alert-product:last-child {
            border-bottom: none;
        }

        .product-name {
            font-weight: 500;
        }

        .product-metric {
            font-weight: 600;
        }

        .positive {
            color: #4CAF50;
        }

        .negative {
            color: #F44336;
        }

        .alert-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 0.9rem;
        }

        .primary-action {
            background: var(--primary);
            color: white;
        }

        .primary-action:hover {
            background: #7a4ba8;
            transform: translateY(-2px);
        }

        .secondary-action {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .secondary-action:hover {
            background: rgba(139, 95, 191, 0.1);
            transform: translateY(-2px);
        }

        /* Purchase Order Modal */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--primary);
        }

        .po-items {
            margin-bottom: 25px;
        }

        .po-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .po-item:last-child {
            border-bottom: none;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: var(--dark);
        }

        .item-info {
            font-size: 0.9rem;
            color: var(--text);
            margin-top: 5px;
        }

        .item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quantity-btn:hover {
            background: #7a4ba8;
        }

        .quantity-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }

        .whatsapp-btn {
            background: #25D366;
            color: white;
        }

        .whatsapp-btn:hover {
            background: #128C7E;
            transform: translateY(-2px);
        }

        /* Footer */

        footer {
            background: var(--dark);
            color: white;
            padding: 60px 0 30px;
            border-radius: 40px 40px 0 0;
            margin-top: 60px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-column h3 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: white;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: #CBD5E0;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: white;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid #4A5568;
            color: #CBD5E0;
        }

        .social-icons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .social-icons a {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s;
        }

        .social-icons a:hover {
            background: var(--primary);
            transform: translateY(-3px);
        }

        /* Responsive Design */

        @media (max-width: 1024px) {
            .alerts-section {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        @media (max-width: 768px) {
            header {
                top: 10px;
                border-radius: 15px;
                margin: 0 15px;
                width: calc(100% - 30px);
            }

            .navbar {
                flex-direction: column;
                padding: 15px 0;
            }

            .nav-links {
                margin: 20px 0;
                flex-wrap: wrap;
                justify-content: center;
            }

            .nav-links li {
                margin: 0 10px 10px;
            }

            .auth-buttons {
                margin-top: 10px;
            }

            .advisor-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .advisor-header h1 {
                text-align: left;
            }

            .alerts-section {
                grid-template-columns: 1fr;
            }

            .alert-header {
                flex-direction: column;
            }

            .alert-icon {
                align-self: flex-start;
                margin-top: 10px;
            }

            .modal {
                padding: 20px;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .alert-card {
                padding: 20px;
            }

            .alert-actions {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                text-align: center;
            }

            .po-item {
                flex-direction: column;
                gap: 10px;
            }

            .item-quantity {
                align-self: flex-end;
            }
        }
    </style>
</head>

<body>
    <script>
        // These lines pull the JSON strings from the Python context (views.py)
        // and convert them into usable JavaScript objects.
        var REORDER_JSON = JSON.parse('{{ reorder_suggestions_json|safe }}');
        var WASTE_JSON = JSON.parse('{{ waste_alerts_json|safe }}');
        var TREND_JSON = JSON.parse('{{ trend_alerts_json|safe }}'); // <--- New Trend Data
    </script>
    <!-- CRITICAL: ADD THIS HIDDEN CSRF INPUT FIELD HERE -->
    {% csrf_token %}

    <!-- Header & Navigation -->
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <!-- FIXED: Link to Django URL -->
                    <a href="{% url 'landing-page' %}">
                        <i class="fas fa-chart-line"></i>
                        <span>Profitify</span>
                    </a>
                </div>
                <div class="auth-buttons">
                    <!-- FIXED: Link to Django URL -->
                    <a href="{% url 'dashboard-page' %}" class="btn btn-primary">Dashboard</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- AI Advisor Content -->
    <div class="container">
        <!-- AI Advisor Header -->
        <div class="advisor-header">
            <!-- FIXED: Link to Django URL -->
            <a href="{% url 'dashboard-page' %}" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>AI Business Advisor</h1>
            <!-- FIXED: Link to Django URL -->
            <a href="{% url 'settings-page' %}" class="settings-btn">
                <i class="fas fa-cog"></i>
            </a>
        </div>

        <!-- AI Summary Block (SECURE BACKEND CALL) -->
        <!-- AI Summary Block (GROQ AI INTEGRATION) -->
        <div class="ai-box"
            style="margin: 20px 0; padding: 25px; border: 1px solid #ddd; border-radius: 15px; background: rgba(255, 255, 255, 0.95); box-shadow: 0 5px 15px rgba(139, 95, 191, 0.1);">
            <h3 style="color: var(--dark); margin-bottom: 10px;">AI-Powered Business Summary</h3>
            <p style="color: var(--text); margin-bottom: 15px;">Click below to generate a concise, actionable analysis
                of your current inventory and sales data.</p>
            <button id="ai-button" class="btn btn-primary"
                style="background-color: var(--primary); padding: 10px 20px; border-radius: 8px;">Generate AI
                Advice</button>
            <div id="ai-response"
                style="margin-top: 15px; background-color: var(--light); border: 1px dashed #ccc; padding: 15px; border-radius: 8px; white-space: pre-wrap; color: var(--dark); font-weight: 500;">
                Click 'Generate AI Advice' to view recommendations.
            </div>
        </div>

        <!-- Alert Cards -->
        <div class="alerts-section">
            <!-- Trend Alert (Keeping static as per views.py placeholder) -->
            <div class="alert-card trend-alert">
                <div class="alert-header">
                    <div>
                        <h3 class="alert-title">Trend Alerts</h3>
                        <p class="alert-description">Products with increasing demand patterns</p>
                    </div>
                    <div class="alert-icon trend-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="alert-content">
                    <ul class="alert-products">
                        <li class="alert-product">
                            <span class="product-name">{{ trend_alerts.0.product_name }}</span>
                            <span class="product-metric positive">{{ trend_alerts.0.message }}</span>
                        </li>
                    </ul>
                </div>
                <div class="alert-actions">
                    <button class="action-btn primary-action add-to-po" data-type="trend">Add to PO</button>
                    <button class="action-btn secondary-action">Create Discount</button>
                </div>
            </div>

            <!-- Waste Alert (DYNAMIC) -->
            <div class="alert-card waste-alert">
                <div class="alert-header">
                    <div>
                        <h3 class="alert-title">Waste Alerts</h3>
                        <p class="alert-description">Products approaching expiry or slow-moving</p>
                    </div>
                    <div class="alert-icon waste-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="alert-content">
                    <ul class="alert-products">
                        {% for item in waste_alerts %}
                        <li class="alert-product">
                            <span class="product-name">{{ item.product.product_name }}</span>
                            <span class="product-metric negative">Expires: {{ item.expiry_date|date:"M d, Y" }}</span>
                        </li>
                        {% empty %}
                        <li class="alert-product">
                            <span class="product-name">All inventory is fresh.</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="alert-actions">
                    <button class="action-btn primary-action add-to-po" data-type="waste">Add to PO</button>
                    <button class="action-btn secondary-action">Create Discount</button>
                </div>
            </div>

            <!-- Recoder Alert (DYNAMIC) -->
            <div class="alert-card recoder-alert">
                <div class="alert-header">
                    <div>
                        <h3 class="alert-title">Reorder Alerts</h3>
                        <p class="alert-description">Products with low stock levels</p>
                    </div>
                    <div class="alert-icon recoder-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                </div>
                <div class="alert-content">
                    <ul class="alert-products">
                        {% for item in reorder_suggestions %}
                        <li class="alert-product">
                            <span class="product-name">{{ item.name }}</span>
                            <span class="product-metric negative">Stock: {{ item.current_stock }} (Req: {{
                                item.reorder_level }})</span>
                        </li>
                        {% empty %}
                        <li class="alert-product">
                            <span class="product-name">All products are well-stocked.</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="alert-actions">
                    <button class="action-btn primary-action add-to-po" data-type="recoder">Add to PO</button>
                    <button class="action-btn secondary-action">View Details</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Order Modal (Kept intact) -->
    <div class="modal-overlay" id="poModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Purchase Order Review</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="po-items" id="poItems">
                <!-- Items will be dynamically added here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancelPo">Cancel</button>
                <button class="btn whatsapp-btn" id="sendWhatsApp">
                    <i class="fab fa-whatsapp"></i> Send via WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Profitify</h3>
                    <p>Making inventory management simple and profitable through AI and smart analytics.</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>

                <div class="footer-column">
                    <h3>Product</h3>
                    <ul class="footer-links">
                        <li><a href="{% url 'landing-page' %}#features">Features</a></li>
                        <li><a href="{% url 'landing-page' %}#working">How It Works</a></li>
                        <li><a href="#">Pricing</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h3>Support</h3>
                    <ul class="footer-links">
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul class="footer-links">
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 Profitify. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- FINAL AI JAVASCRIPT LOGIC (Secure Backend Call) -->
    <!-- CLEAN WORKING AI JAVASCRIPT -->
    <script>
        // Groq AI Integration - YOUR API KEY IS WORKING!
        const GROQ_API_KEY = "{{ GROQ_API_KEY }}";
        const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";

        // Get your inventory data from Django template variables
        const reorderData = REORDER_JSON;
        const wasteData = WASTE_JSON;
        const trendData = TREND_JSON;

        const aiButton = document.getElementById('ai-button');
        const aiResponse = document.getElementById('ai-response');

        // Function to build unique business context every time
        function buildBusinessContext() {
            const randomGreetings = [
                "Give me fresh shop advice for today",
                "What should I focus on in my shop this week?",
                "Give me new ideas to improve my shop",
                "What are today's best recommendations?",
                "Help me make my shop more profitable"
            ];

            const randomGreeting = randomGreetings[Math.floor(Math.random() * randomGreetings.length)];

            let context = `${randomGreeting}. Use VERY SIMPLE English with emojis.\n\n`;
            context += "RULES:\n";
            context += "- Use ‚úÖ for good things\n";
            context += "- Use ‚ùå for problems\n";
            context += "- Use ‚ö†Ô∏è for warnings\n";
            context += "- Use simple words only\n";
            context += "- Give NEW ideas each time\n\n";

            context += "MY SHOP DATA:\n";

            // Add waste alerts data
            if (wasteData && wasteData.length > 0) {
                context += "Products expiring soon:\n";
                wasteData.forEach(item => {
                    context += `- ${item.product || 'Product'} (expires: ${item.expiry_date})\n`;
                });
            }

            // Add reorder alerts data  
            if (reorderData && reorderData.length > 0) {
                context += "\nProducts with low stock:\n";
                reorderData.forEach(item => {
                    context += `- ${item.name} (only ${item.current_stock} left)\n`;
                });
            }

            // Add trend data if available
            if (trendData && trendData.length > 0) {
                context += "\nProducts selling fast:\n";
                trendData.forEach(item => {
                    context += `- ${item.product_name}\n`;
                });
            }

            context += "\nPlease give me unique advice with emojis. Make it different from last time!";

            return context;
        }

        // Main function to call Groq API
        async function generateAIAdvice() {
            if (!aiButton || !aiResponse) {
                console.error("AI button or response element not found");
                return;
            }

            aiButton.disabled = true;
            aiButton.textContent = "‚è≥ Thinking...";
            aiResponse.innerText = "ü§î Asking AI for fresh advice...";
            aiResponse.style.color = "var(--dark)";

            try {
                const businessContext = buildBusinessContext();

                const requestBody = {
                    messages: [
                        {
                            role: "system",
                            content: "You are a helpful business advisor for small shop owners in India. Use very simple English with lots of emojis. Keep responses under 200 words. Give practical, actionable advice. Make each response unique and fresh."
                        },
                        {
                            role: "user",
                            content: businessContext
                        }
                    ],
                    model: "openai/gpt-oss-20b",
                    temperature: 1,
                    max_tokens: 512,
                    top_p: 1,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(GROQ_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`AI service error: ${errorData.error?.message || 'Please try again'}`);
                }

                const data = await response.json();

                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiOutput = data.choices[0].message.content;

                    // Add timestamp to show it's fresh
                    const timestamp = new Date().toLocaleTimeString();
                    aiResponse.innerHTML = `üïí <strong>Updated at ${timestamp}</strong>\n\n${aiOutput}`;

                    aiResponse.style.color = "var(--dark)";
                    aiResponse.style.whiteSpace = "pre-wrap";
                    aiResponse.style.lineHeight = "1.6";
                    aiResponse.style.fontSize = "16px";

                    aiButton.textContent = "üîÑ Get New Advice";

                } else {
                    throw new Error("No response from AI");
                }

            } catch (error) {
                console.error("AI Error:", error);

                // Show user-friendly error
                const timestamp = new Date().toLocaleTimeString();
                aiResponse.innerHTML = `‚ùå <strong>Error at ${timestamp}</strong>\n\n${error.message}\n\nPlease try again in a moment.`;
                aiResponse.style.color = "#F44336";

            } finally {
                aiButton.disabled = false;
                if (aiButton.textContent === "‚è≥ Thinking...") {
                    aiButton.textContent = "üîÑ Try Again";
                }
            }
        }

        // Add success indicator to show API key is working
        function showSuccessIndicator() {
            const successDiv = document.createElement('div');
            successDiv.innerHTML = '‚úÖ <strong>AI System Ready!</strong> Your API key is working.';
            successDiv.style.marginTop = '10px';
            successDiv.style.padding = '10px';
            // successDiv.style.backgroundColor = 'var(--pastel-green)';
            successDiv.style.borderRadius = '8px';
            successDiv.style.fontSize = '14px';

            const aiBox = document.querySelector('.ai-box');
            if (aiBox) {
                aiBox.appendChild(successDiv);
            }
        }

        // Event listener for AI button
        if (aiButton) {
            aiButton.addEventListener('click', generateAIAdvice);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function () {
            // Show success indicator
            showSuccessIndicator();

            // Modal closing logic
            const poModal = document.getElementById('poModal');
            if (poModal) {
                const poCloseButtons = poModal.querySelectorAll('.close-modal');
                const poCancelButton = document.getElementById('cancelPo');

                poCloseButtons.forEach(btn => {
                    btn.addEventListener('click', () => poModal.classList.remove('active'));
                });

                if (poCancelButton) {
                    poCancelButton.addEventListener('click', () => poModal.classList.remove('active'));
                }
            }

            // Update initial message to show it's ready
            const initialResponse = document.getElementById('ai-response');
            // if (initialResponse) {
            //     initialResponse.innerHTML = "‚úÖ <strong>AI System Ready!</strong> Click 'Generate AI Advice' to get personalized business recommendations with emojis!";
            //     initialResponse.style.backgroundColor = "var(--pastel-green)";
            //     initialResponse.style.padding = "15px";
            //     initialResponse.style.borderRadius = "10px";
            // }

            console.log("üéØ AI System Ready - API Key is working!");
        });
    </script>
</body>

</html>